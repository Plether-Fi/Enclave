<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, system-ui; padding: 24px; background: #fafafa; color: #111; }
h2 { font-size: 18px; margin-bottom: 16px; }
h3 { font-size: 13px; color: #666; margin: 16px 0 8px; text-transform: uppercase; letter-spacing: 0.5px; }
.card { background: white; border-radius: 10px; padding: 16px; border: 1px solid #e5e5e5; margin-bottom: 12px; }
button {
    padding: 8px 16px; border-radius: 8px; border: 1px solid #ddd;
    background: #111; color: white; font-size: 13px; cursor: pointer;
    margin: 4px 4px 4px 0;
}
button:hover { background: #333; }
button:active { background: #555; }
.result {
    margin-top: 8px; padding: 8px; background: #f5f5f5; border-radius: 6px;
    font-family: monospace; font-size: 12px; word-break: break-all;
    white-space: pre-wrap; max-height: 200px; overflow-y: auto;
}
.result.error { background: #fef2f2; color: #dc2626; }
.result.success { background: #f0fdf4; color: #16a34a; }
.hint { font-size: 11px; color: #888; margin: 4px 0 8px; line-height: 1.5; }
#status { font-size: 13px; color: #999; margin-bottom: 12px; }
input {
    padding: 8px; border-radius: 6px; border: 1px solid #ddd;
    font-family: monospace; font-size: 12px; width: 100%; margin: 4px 0;
}
</style>
</head>
<body>

<h2>Kitchen Sink</h2>
<div id="status">Not connected</div>

<div class="card">
    <h3>Connection</h3>
    <button onclick="connectWallet()">Connect Wallet</button>
    <button onclick="getChainId()">Chain ID</button>
    <button onclick="getBlockNumber()">Block Number</button>
    <div id="conn-result" class="result" style="display:none"></div>
</div>

<div class="card">
    <h3>Network</h3>
    <button onclick="switchChain('0x66eee')">Arb Sepolia (421614)</button>
    <button onclick="switchChain('0xa4b1')">Arb One (42161)</button>
    <div id="chain-result" class="result" style="display:none"></div>
</div>

<div class="card">
    <h3>Wallet Status</h3>
    <div id="deploy-status" style="font-size:13px;color:#999">Connect wallet to check</div>
</div>

<div class="card">
    <h3>Balance</h3>
    <button onclick="getBalance()">Get ETH Balance</button>
    <div id="bal-result" class="result" style="display:none"></div>
</div>

<div class="card">
    <h3>EIP-712 Sign</h3>
    <div class="hint">Off-chain signature. Hashes EIP-712 structured data (domain + types + message), then signs with a secp256k1 session key. First sign registers the key on-chain (Touch ID + gas), after that signatures are instant — no Touch ID, no gas. Wallet must be deployed.</div>
    <div id="eip712-preview" class="result" style="display:block"></div>
    <button onclick="signTypedData()">Sign Typed Data</button>
    <div id="eip712-result" class="result" style="display:none"></div>
</div>

<div class="card">
    <h3>Send Transaction</h3>
    <div class="hint">On-chain transaction. Builds an ERC-4337 UserOperation signed with the P-256 Secure Enclave key — requires Touch ID and gas every time. Session keys cannot send transactions. First tx auto-deploys the wallet via initCode.</div>
    <input id="send-to" type="text" placeholder="Recipient (0x...)">
    <input id="send-value" type="text" value="0" placeholder="Value in wei (hex, e.g. 0x0)">
    <button onclick="sendTx()">Send</button>
    <div id="send-result" class="result" style="display:none"></div>
</div>

<div class="card">
    <h3>Session Keys</h3>
    <button onclick="listSessionKeys()">List Keys</button>
    <div id="sk-list" style="margin-top:8px"></div>
    <div id="sk-result" class="result" style="display:none"></div>
</div>

<script>
function makeJazzicon(address, size) {
    size = size || 32;
    var mt = new Array(624), mti = 625;
    function initMT(seed) {
        mt[0] = seed >>> 0; mti = 1;
        while (mti < 624) { mt[mti] = (1812433253 * ((mt[mti-1] ^ (mt[mti-1] >>> 30)) >>> 0) + mti) >>> 0; mti++; }
    }
    function genMT() {
        var y, mag = [0, 0x9908b0df];
        if (mti >= 624) {
            for (var k = 0; k < 227; k++) { y = (mt[k] & 0x80000000) | (mt[k+1] & 0x7fffffff); mt[k] = mt[k+397] ^ (y >>> 1) ^ mag[y & 1]; }
            for (; k < 623; k++) { y = (mt[k] & 0x80000000) | (mt[k+1] & 0x7fffffff); mt[k] = mt[k-227] ^ (y >>> 1) ^ mag[y & 1]; }
            y = (mt[623] & 0x80000000) | (mt[0] & 0x7fffffff); mt[623] = mt[396] ^ (y >>> 1) ^ mag[y & 1]; mti = 0;
        }
        y = mt[mti++]; y ^= y >>> 11; y ^= (y << 7) & 0x9d2c5680; y ^= (y << 15) & 0xefc60000; y ^= y >>> 18;
        return (y >>> 0) / 4294967296;
    }
    initMT(parseInt(address.slice(2, 10), 16));
    var palette = ['#01888C','#FC7500','#034F5D','#F73F01','#FC1960','#C7144C','#F3C100','#1598F2','#2465E1','#F19E02'];
    var hueShift = Math.floor(genMT() * 30) - 15;
    function shiftHue(hex) {
        var r = parseInt(hex.slice(1,3),16)/255, g = parseInt(hex.slice(3,5),16)/255, b = parseInt(hex.slice(5,7),16)/255;
        var max = Math.max(r,g,b), min = Math.min(r,g,b), d = max-min, h = 0, s = max ? d/max : 0, v = max;
        if (d) { h = max===r ? (g-b)/d+(g<b?6:0) : max===g ? (b-r)/d+2 : (r-g)/d+4; h *= 60; }
        h = ((h + hueShift) % 360 + 360) % 360;
        var hi = Math.floor(h/60)%6, f = h/60-Math.floor(h/60), p = v*(1-s), q = v*(1-f*s), t = v*(1-(1-f)*s);
        var ro,go,bo;
        if (hi===0){ro=v;go=t;bo=p;} else if(hi===1){ro=q;go=v;bo=p;} else if(hi===2){ro=p;go=v;bo=t;}
        else if(hi===3){ro=p;go=q;bo=v;} else if(hi===4){ro=t;go=p;bo=v;} else{ro=v;go=p;bo=q;}
        return '#'+[ro,go,bo].map(function(c){var h=Math.round(c*255).toString(16);return h.length<2?'0'+h:h;}).join('');
    }
    var bgIdx = Math.floor(genMT() * palette.length);
    var bg = shiftHue(palette.splice(bgIdx, 1)[0]);
    var half = size / 2;
    var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="'+size+'" height="'+size+'">' +
        '<defs><clipPath id="c"><circle cx="'+half+'" cy="'+half+'" r="'+half+'"/></clipPath></defs>' +
        '<g clip-path="url(#c)"><rect width="'+size+'" height="'+size+'" fill="'+bg+'"/>';
    for (var i = 0; i < 4; i++) {
        var idx = Math.floor(genMT() * palette.length);
        var fill = shiftHue(palette.splice(idx, 1)[0]);
        var angle = genMT() * 360, dist = genMT() * half * 0.6, theta = genMT() * Math.PI * 2;
        var cx = half + Math.cos(theta) * dist, cy = half + Math.sin(theta) * dist;
        var w = size * (0.25 + genMT() * 0.4), h = size * (0.25 + genMT() * 0.4);
        svg += '<rect x="'+(cx-w/2)+'" y="'+(cy-h/2)+'" width="'+w+'" height="'+h+'" fill="'+fill+'" transform="rotate('+angle+' '+cx+' '+cy+')"/>';
    }
    svg += '</g></svg>';
    return 'data:image/svg+xml;base64,' + btoa(svg);
}

let pending = {};
let nextId = 1;
let account = null;

function request(method, params) {
    return new Promise((resolve, reject) => {
        const id = nextId++;
        pending[id] = { resolve, reject };
        window.webkit.messageHandlers.enclave.postMessage(JSON.stringify({ id, method, params }));
    });
}

function _enclaveResponse(id, result, error) {
    const p = pending[id];
    if (!p) return;
    if (error) p.reject(new Error(error));
    else p.resolve(result);
    delete pending[id];
}

function _enclaveAccountsChanged(accounts) {
    account = accounts[0] || null;
    document.getElementById('status').textContent = account ? 'Connected: ' + account : 'Not connected';
    checkDeployStatus();
}

function _enclaveChainChanged(chainId) {
    show('chain-result', 'Chain changed to: ' + chainId + ' (' + parseInt(chainId, 16) + ')');
    checkDeployStatus();
}

function show(elId, text, isError) {
    const el = document.getElementById(elId);
    el.style.display = 'block';
    el.textContent = typeof text === 'object' ? JSON.stringify(text, null, 2) : text;
    el.className = 'result ' + (isError ? 'error' : 'success');
}

function explorerURL(chainId, address) {
    var id = parseInt(chainId, 16);
    if (id === 421614) return 'https://sepolia.arbiscan.io/address/' + address;
    if (id === 42161) return 'https://arbiscan.io/address/' + address;
    return null;
}

async function checkDeployStatus() {
    var el = document.getElementById('deploy-status');
    if (!account) { el.textContent = 'Connect wallet to check'; return; }
    try {
        var code = await request('eth_getCode', [account, 'latest']);
        var chainId = await request('eth_chainId', []);
        var deployed = code && code !== '0x' && code !== '0x0';
        if (deployed) {
            var url = explorerURL(chainId, account);
            el.innerHTML = '<span style="color:#2e7d32;font-weight:600">Deployed</span>' +
                (url ? ' &middot; <a href="' + url + '" target="_blank" style="color:#1598F2;text-decoration:none">View on Arbiscan</a>' : '');
        } else {
            el.innerHTML = '<span style="color:#e65100;font-weight:600">Not deployed</span>' +
                '<div style="color:#888;font-size:11px;margin-top:4px">Send a transaction to auto-deploy via initCode.</div>';
        }
    } catch (e) { el.textContent = 'Error: ' + e.message; }
}

async function connectWallet() {
    try {
        const accounts = await request('eth_requestAccounts', []);
        account = accounts[0];
        document.getElementById('status').textContent = 'Connected: ' + account;
        show('conn-result', 'Accounts: ' + JSON.stringify(accounts));
        checkDeployStatus();
    } catch (e) { show('conn-result', e.message, true); }
}

async function getChainId() {
    try {
        const id = await request('eth_chainId', []);
        show('conn-result', 'Chain ID: ' + id + ' (' + parseInt(id, 16) + ')');
    } catch (e) { show('conn-result', e.message, true); }
}

async function switchChain(chainId) {
    try {
        await request('wallet_switchEthereumChain', [{ chainId }]);
        show('chain-result', 'Switched to ' + chainId + ' (' + parseInt(chainId, 16) + ')');
    } catch (e) { show('chain-result', e.message, true); }
}

async function getBlockNumber() {
    try {
        const block = await request('eth_blockNumber', []);
        show('conn-result', 'Block: ' + block + ' (' + parseInt(block, 16) + ')');
    } catch (e) { show('conn-result', e.message, true); }
}

async function getBalance() {
    try {
        if (!account) { show('bal-result', 'Connect wallet first', true); return; }
        const bal = await request('eth_getBalance', [account, 'latest']);
        const wei = BigInt(bal);
        const eth = Number(wei) / 1e18;
        show('bal-result', bal + '\n' + eth.toFixed(6) + ' ETH');
    } catch (e) { show('bal-result', e.message, true); }
}

const eip712Data = {
    types: {
        EIP712Domain: [
            { name: "name", type: "string" },
            { name: "version", type: "string" },
            { name: "chainId", type: "uint256" },
            { name: "verifyingContract", type: "address" }
        ],
        Mail: [
            { name: "from", type: "Person" },
            { name: "to", type: "Person" },
            { name: "contents", type: "string" }
        ],
        Person: [
            { name: "name", type: "string" },
            { name: "wallet", type: "address" }
        ]
    },
    primaryType: "Mail",
    domain: {
        name: "Ether Mail",
        version: "1",
        chainId: 1,
        verifyingContract: "0xCcCCccccCCCCcCCCCCCcCcCccCcCCCcCcccccccC"
    },
    message: {
        from: { name: "Alice", wallet: "0xCD2a3d9F938E13CD947Ec05AbC7FE734Df8DD826" },
        to: { name: "Bob", wallet: "0xbBbBBBBbbBBBbbbBbbBbbbbBBbBbbbbBbBbbBBbB" },
        contents: "Hello, Bob!"
    }
};

document.getElementById('eip712-preview').textContent =
    'Domain: ' + eip712Data.domain.name + ' v' + eip712Data.domain.version +
    '\nType: ' + eip712Data.primaryType +
    '\n\nMessage:' +
    '\n  from: ' + eip712Data.message.from.name + ' (' + eip712Data.message.from.wallet + ')' +
    '\n  to: ' + eip712Data.message.to.name + ' (' + eip712Data.message.to.wallet + ')' +
    '\n  contents: "' + eip712Data.message.contents + '"';

async function signTypedData() {
    try {
        if (!account) { show('eip712-result', 'Connect wallet first', true); return; }
        const sig = await request('eth_signTypedData_v4', [account, JSON.stringify(eip712Data)]);
        show('eip712-result', sig);
    } catch (e) { show('eip712-result', e.message, true); }
}

async function sendTx() {
    try {
        if (!account) { show('send-result', 'Connect wallet first', true); return; }
        const to = document.getElementById('send-to').value;
        const value = document.getElementById('send-value').value || '0x0';
        const hash = await request('eth_sendTransaction', [{ from: account, to, value }]);
        show('send-result', 'Tx hash: ' + hash);
    } catch (e) { show('send-result', e.message, true); }
}

async function listSessionKeys() {
    try {
        const keys = await request('enclave_listSessionKeys', []);
        const container = document.getElementById('sk-list');
        if (!keys || keys.length === 0) {
            container.innerHTML = '<div style="color:#999;font-size:12px">No session keys</div>';
            return;
        }
        container.innerHTML = keys.map(k =>
            '<div style="display:flex;align-items:center;gap:8px;padding:6px 0;font-size:12px;border-bottom:1px solid #eee">' +
            '<img src="' + makeJazzicon(k.address, 32) + '" style="width:32px;height:32px;border-radius:4px;flex-shrink:0">' +
            '<div style="flex:1;min-width:0"><div style="font-family:monospace;font-size:11px;overflow:hidden;text-overflow:ellipsis">' + k.address + '</div>' +
            '<div style="color:#999;font-size:11px">' + k.appId + '</div></div>' +
            '<button onclick="revokeSessionKey(\'' + k.appId.replace(/'/g, "\\'") + '\')" style="background:#dc2626;font-size:11px;padding:4px 8px">Revoke</button></div>'
        ).join('');
    } catch (e) { show('sk-result', e.message, true); }
}

async function revokeSessionKey(appId) {
    try {
        await request('enclave_revokeSessionKey', [appId]);
        show('sk-result', 'Revoked: ' + appId);
        listSessionKeys();
    } catch (e) { show('sk-result', e.message, true); }
}
</script>
</body>
</html>
