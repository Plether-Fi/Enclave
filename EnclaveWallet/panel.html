<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, system-ui; padding: 16px; background: #fafafa; color: #111; }
h3 { font-size: 13px; color: #666; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }

/* Wallet section */
#wallet { margin-bottom: 20px; }
.wallet-addr {
    display: flex; align-items: center; gap: 8px;
    background: #eee; padding: 6px 12px; border-radius: 999px; cursor: pointer;
    border: 1px solid #ddd; user-select: none;
}
.wallet-addr:hover { background: #e0e0e0; }
#wallet-address { display: flex; align-items: center; gap: 8px; }
.blockie { width: 40px; height: 40px; border-radius: 4px; vertical-align: middle; margin-right: 6px; }
.wallet-menu-item .blockie { width: 40px; height: 40px; margin-right: 0; flex-shrink: 0; }
.wallet-menu {
    display: none; position: absolute; background: white; border: 1px solid #ddd;
    border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.12); z-index: 10;
    left: 0; right: 0; padding: 4px 0; margin-top: 4px;
}
.wallet-menu.open { display: block; }
.wallet-menu-item {
    display: flex; align-items: center; gap: 8px; width: 100%; padding: 8px 14px; font-size: 12px;
    background: none; border: none; text-align: left;
    cursor: pointer; color: #111;
}
.wallet-menu-item:hover { background: #f0f0f0; }
.wallet-menu-item.active { font-weight: 700; }
.wallet-menu-item .wm-info { display: flex; flex-direction: column; min-width: 0; }
.wallet-menu-item .wm-name { font-family: -apple-system, system-ui; font-size: 12px; }
.wallet-menu-item .wm-addr { font-family: monospace; font-size: 10px; color: #999; }
.wm-badge { font-size: 9px; padding: 1px 5px; border-radius: 3px; font-family: -apple-system, system-ui; margin-left: 4px; }
.wm-badge.deployed { background: #e8f5e9; color: #2e7d32; }
.wm-badge.not-deployed { background: #fff3e0; color: #e65100; }
.wallet-menu-item .wm-rename {
    font-size: 12px; font-family: -apple-system, system-ui; border: 1px solid #ddd;
    border-radius: 4px; padding: 2px 6px; width: 100%; outline: none;
}
.wallet-menu-item .wm-rename:focus { border-color: #007aff; }
.pill-info { display: flex; flex-direction: column; line-height: 1.2; }
.pill-name { font-family: -apple-system, system-ui; font-size: 13px; font-weight: 500; }
.pill-addr { font-family: monospace; font-size: 10px; color: #888; }
.wallet-menu-sep { height: 1px; background: #e5e5e5; margin: 4px 0; }
.wallet-menu-item.new-wallet { font-family: -apple-system, system-ui; color: #007aff; }

.balances { display: flex; gap: 20px; margin: 10px 0; }
.bal { font-size: 14px; font-family: monospace; font-weight: 600; }
.bal span { font-weight: 400; color: #666; font-family: -apple-system, system-ui; font-size: 12px; }

.actions { display: flex; gap: 8px; margin: 10px 0; flex-wrap: wrap; }
.btn {
    font-size: 12px; padding: 6px 14px; border-radius: 8px; border: 1px solid #ddd;
    background: white; cursor: pointer; font-family: -apple-system, system-ui;
    display: flex; align-items: center; gap: 4px;
}
.btn:hover { background: #f0f0f0; }
.btn.primary { background: #111; color: white; border-color: #111; }
.btn.primary:hover { background: #333; }

.top-row { display: flex; align-items: center; gap: 8px; }
.btn-qr {
    width: 36px; height: 36px; border-radius: 50%; border: 1px solid #ddd;
    background: white; cursor: pointer; display: flex; align-items: center;
    justify-content: center; color: #111; flex-shrink: 0;
}
.btn-qr:hover { background: #f0f0f0; }

.divider { height: 1px; background: #e5e5e5; margin: 16px 0; }

/* Activity section */
.card { background: white; border-radius: 10px; padding: 12px; border: 1px solid #e5e5e5; }
.row { display: flex; align-items: center; padding: 6px 0; }
.row + .row { border-top: 1px solid #f0f0f0; }
.icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 14px; flex-shrink: 0; }
.icon.in { background: #dcfce7; color: #16a34a; }
.icon.out { background: #fff7ed; color: #ea580c; }
.details { flex: 1; min-width: 0; }
.label { font-size: 13px; font-weight: 500; }
.addr { font-size: 10px; color: #999; font-family: monospace; }
.amount { text-align: right; flex-shrink: 0; }
.amount .val { font-size: 13px; font-weight: 600; font-family: monospace; }
.amount .time { font-size: 10px; color: #999; }
.empty { text-align: center; padding: 32px 0; color: #999; font-size: 13px; }
#loading { text-align: center; padding: 32px 0; color: #999; font-size: 13px; }
</style>
</head>
<body>

<div id="wallet">
    <div class="top-row">
        <div style="position: relative; flex: 1; min-width: 0;">
            <div class="wallet-addr" onclick="toggleWalletMenu(event)">
                <span id="wallet-address">No Wallet</span> <span style="margin-left: auto;">â–¾</span>
            </div>
            <div class="wallet-menu" id="wallet-menu"></div>
        </div>
        <button class="btn-qr" onclick="post('receive')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
                <path d="M2 8V3a1 1 0 011-1h5"/><path d="M16 2h5a1 1 0 011 1v5"/><path d="M22 16v5a1 1 0 01-1 1h-5"/><path d="M8 22H3a1 1 0 01-1-1v-5"/><rect x="7" y="7" width="10" height="10" rx="1"/>
            </svg>
        </button>
    </div>

    <div class="balances">
        <div class="bal"><span id="eth-bal">...</span> <span>ETH</span></div>
        <div class="bal"><span id="usdc-bal">...</span> <span>USDC</span></div>
    </div>

    <div class="actions">
        <button class="btn primary" onclick="post('send')">â†‘ Send</button>
        <button class="btn" onclick="post('pasteWC')">ðŸ”— WC</button>
    </div>
</div>

<div class="divider"></div>

<h3>Activity</h3>
<div id="loading">Loading...</div>
<div id="history"></div>

<script>
function makeJazzicon(address, size) {
    size = size || 32;
    var mt = new Array(624), mti = 625;
    function initMT(seed) {
        mt[0] = seed >>> 0; mti = 1;
        while (mti < 624) {
            mt[mti] = (1812433253 * ((mt[mti-1] ^ (mt[mti-1] >>> 30)) >>> 0) + mti) >>> 0;
            mti++;
        }
    }
    function genMT() {
        var y, mag = [0, 0x9908b0df];
        if (mti >= 624) {
            for (var k = 0; k < 227; k++) {
                y = (mt[k] & 0x80000000) | (mt[k+1] & 0x7fffffff);
                mt[k] = mt[k+397] ^ (y >>> 1) ^ mag[y & 1];
            }
            for (; k < 623; k++) {
                y = (mt[k] & 0x80000000) | (mt[k+1] & 0x7fffffff);
                mt[k] = mt[k-227] ^ (y >>> 1) ^ mag[y & 1];
            }
            y = (mt[623] & 0x80000000) | (mt[0] & 0x7fffffff);
            mt[623] = mt[396] ^ (y >>> 1) ^ mag[y & 1];
            mti = 0;
        }
        y = mt[mti++];
        y ^= y >>> 11; y ^= (y << 7) & 0x9d2c5680;
        y ^= (y << 15) & 0xefc60000; y ^= y >>> 18;
        return (y >>> 0) / 4294967296;
    }
    initMT(parseInt(address.slice(2, 10), 16));
    var palette = ['#01888C','#FC7500','#034F5D','#F73F01','#FC1960','#C7144C','#F3C100','#1598F2','#2465E1','#F19E02'];
    var hueShift = Math.floor(genMT() * 30) - 15;
    function shiftHue(hex) {
        var r = parseInt(hex.slice(1,3),16)/255, g = parseInt(hex.slice(3,5),16)/255, b = parseInt(hex.slice(5,7),16)/255;
        var max = Math.max(r,g,b), min = Math.min(r,g,b), d = max-min, h = 0, s = max ? d/max : 0, v = max;
        if (d) { h = max===r ? (g-b)/d+(g<b?6:0) : max===g ? (b-r)/d+2 : (r-g)/d+4; h *= 60; }
        h = ((h + hueShift) % 360 + 360) % 360;
        var hi = Math.floor(h/60)%6, f = h/60-Math.floor(h/60), p = v*(1-s), q = v*(1-f*s), t = v*(1-(1-f)*s);
        var ro,go,bo;
        if (hi===0){ro=v;go=t;bo=p;} else if(hi===1){ro=q;go=v;bo=p;} else if(hi===2){ro=p;go=v;bo=t;}
        else if(hi===3){ro=p;go=q;bo=v;} else if(hi===4){ro=t;go=p;bo=v;} else{ro=v;go=p;bo=q;}
        return '#'+[ro,go,bo].map(function(c){var h=Math.round(c*255).toString(16);return h.length<2?'0'+h:h;}).join('');
    }
    var bgIdx = Math.floor(genMT() * palette.length);
    var bg = shiftHue(palette.splice(bgIdx, 1)[0]);
    var half = size / 2;
    var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="'+size+'" height="'+size+'">' +
        '<defs><clipPath id="c"><circle cx="'+half+'" cy="'+half+'" r="'+half+'"/></clipPath></defs>' +
        '<g clip-path="url(#c)"><rect width="'+size+'" height="'+size+'" fill="'+bg+'"/>';
    for (var i = 0; i < 4; i++) {
        var idx = Math.floor(genMT() * palette.length);
        var fill = shiftHue(palette.splice(idx, 1)[0]);
        var angle = genMT() * 360;
        var dist = genMT() * half * 0.6;
        var theta = genMT() * Math.PI * 2;
        var cx = half + Math.cos(theta) * dist;
        var cy = half + Math.sin(theta) * dist;
        var w = size * (0.25 + genMT() * 0.4);
        var h = size * (0.25 + genMT() * 0.4);
        svg += '<rect x="'+(cx-w/2)+'" y="'+(cy-h/2)+'" width="'+w+'" height="'+h+'" fill="'+fill+'" transform="rotate('+angle+' '+cx+' '+cy+')"/>';
    }
    svg += '</g></svg>';
    return 'data:image/svg+xml;base64,' + btoa(svg);
}

function post(action, data) {
    var msg = { action: action };
    if (data !== undefined) msg.data = data;
    window.webkit.messageHandlers.wallet.postMessage(JSON.stringify(msg));
}

var _walletState = {};

window.updateWallet = function(jsonStr) {
    var s = JSON.parse(jsonStr);
    _walletState = s;

    var addrEl = document.getElementById('wallet-address');
    if (s.address) {
        var pillBadge = s.deployed
            ? '<span class="wm-badge deployed">deployed</span>'
            : '<span class="wm-badge not-deployed">not deployed</span>';
        addrEl.innerHTML = '<img class="blockie" src="' + makeJazzicon(s.address, 40) + '">' +
            '<span class="pill-info"><span class="pill-name">' + (s.name || s.displayAddress) + pillBadge + '</span>' +
            '<span class="pill-addr">' + (s.displayAddress || '') + '</span></span>';
    } else {
        addrEl.textContent = 'No Wallet';
    }
    document.getElementById('eth-bal').textContent = s.ethBalance || '...';
    document.getElementById('usdc-bal').textContent = s.usdcBalance || '...';

    buildWalletMenu(s.wallets || [], s.selectedIndex || 0);
};

function buildWalletMenu(wallets, selectedIndex) {
    var menu = document.getElementById('wallet-menu');
    menu.innerHTML = '';
    wallets.forEach(function(w) {
        var btn = document.createElement('button');
        btn.className = 'wallet-menu-item' + (w.index === selectedIndex ? ' active' : '');
        btn.onclick = function() { selectWallet(w.index); };
        btn.ondblclick = function(e) { e.stopPropagation(); startRename(btn, w); };
        var img = '';
        if (w.address) img = '<img class="blockie" src="' + makeJazzicon(w.address, 40) + '">';
        var badge = w.deployed
            ? '<span class="wm-badge deployed">deployed</span>'
            : '<span class="wm-badge not-deployed">not deployed</span>';
        btn.innerHTML = img + '<span class="wm-info"><span class="wm-name">' + (w.name || w.display) + badge +
            '</span><span class="wm-addr">' + w.display + '</span></span>';
        menu.appendChild(btn);
    });
    if (wallets.length > 0) {
        var sep = document.createElement('div');
        sep.className = 'wallet-menu-sep';
        menu.appendChild(sep);
    }
    var newBtn = document.createElement('button');
    newBtn.className = 'wallet-menu-item new-wallet';
    newBtn.textContent = 'New Wallet';
    newBtn.onclick = function() { post('newWallet'); };
    menu.appendChild(newBtn);
}

function startRename(btn, wallet) {
    var info = btn.querySelector('.wm-info');
    if (!info) return;
    var input = document.createElement('input');
    input.className = 'wm-rename';
    input.value = wallet.name || '';
    info.innerHTML = '';
    info.appendChild(input);
    input.focus();
    input.select();
    function commit() {
        var name = input.value.trim();
        if (name && name !== wallet.name) {
            post('renameWallet', { index: wallet.index, name: name });
        }
    }
    input.onkeydown = function(e) {
        if (e.key === 'Enter') { commit(); input.blur(); }
        if (e.key === 'Escape') { input.blur(); }
    };
    input.onblur = function() { commit(); };
}

function selectWallet(index) {
    closeMenus();
    post('selectWallet', index);
}

function toggleWalletMenu(e) {
    e.stopPropagation();
    document.getElementById('wallet-menu').classList.toggle('open');
}

function closeMenus() {
    document.getElementById('wallet-menu').classList.remove('open');
}

document.addEventListener('click', closeMenus);

window.updateHistory = function(txListJson) {
    var txs = JSON.parse(txListJson);
    var container = document.getElementById('history');
    document.getElementById('loading').style.display = 'none';

    if (!txs.length) {
        container.innerHTML = '<div class="empty">No transactions yet.</div>';
        return;
    }

    var html = '<div class="card">';
    txs.forEach(function(tx) {
        if (tx.contractCreation) {
            html += '<div class="row">' +
                '<div class="icon" style="background:#e8f5e9;color:#2e7d32">+</div>' +
                '<div class="details">' +
                    '<div class="label">Wallet Deployed</div>' +
                    '<div class="addr">' + tx.address + '</div>' +
                '</div>' +
                '<div class="amount"><div class="time">' + tx.time + '</div></div>' +
            '</div>';
        } else {
            var icon = tx.incoming ? 'in' : 'out';
            var label = tx.incoming ? 'Received' : 'Sent';
            var sign = tx.incoming ? '+' : '-';
            html += '<div class="row">' +
                '<div class="icon ' + icon + '">' + (tx.incoming ? 'â†“' : 'â†‘') + '</div>' +
                '<div class="details">' +
                    '<div class="label">' + label + '</div>' +
                    '<div class="addr">' + tx.address + '</div>' +
                '</div>' +
                '<div class="amount">' +
                    '<div class="val">' + sign + tx.value + ' ' + tx.symbol + '</div>' +
                    '<div class="time">' + tx.time + '</div>' +
                '</div>' +
            '</div>';
        }
    });
    html += '</div>';
    container.innerHTML = html;
};
</script>
</body>
</html>
