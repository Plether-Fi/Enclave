<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, system-ui; padding: 16px; background: #fafafa; color: #111; }
h3 { font-size: 13px; color: #666; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }

/* Wallet section */
#wallet { margin-bottom: 20px; }
.wallet-addr {
    display: inline-flex; align-items: center; gap: 8px;
    background: #eee; padding: 6px 12px; border-radius: 999px; cursor: pointer;
    border: 1px solid #ddd; user-select: none;
}
.wallet-addr:hover { background: #e0e0e0; }
#wallet-address { display: flex; align-items: center; gap: 8px; }
.blockie { width: 32px; height: 32px; border-radius: 4px; vertical-align: middle; margin-right: 6px; image-rendering: pixelated; }
.wallet-menu-item .blockie { width: 24px; height: 24px; margin-right: 0; flex-shrink: 0; }
.wallet-menu {
    display: none; position: absolute; background: white; border: 1px solid #ddd;
    border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.12); z-index: 10;
    min-width: 180px; padding: 4px 0; margin-top: 4px;
}
.wallet-menu.open { display: block; }
.wallet-menu-item {
    display: flex; align-items: center; gap: 8px; width: 100%; padding: 8px 14px; font-size: 12px;
    background: none; border: none; text-align: left;
    cursor: pointer; color: #111;
}
.wallet-menu-item:hover { background: #f0f0f0; }
.wallet-menu-item.active { font-weight: 700; }
.wallet-menu-item .wm-info { display: flex; flex-direction: column; min-width: 0; }
.wallet-menu-item .wm-name { font-family: -apple-system, system-ui; font-size: 12px; }
.wallet-menu-item .wm-addr { font-family: monospace; font-size: 10px; color: #999; }
.wallet-menu-item .wm-rename {
    font-size: 12px; font-family: -apple-system, system-ui; border: 1px solid #ddd;
    border-radius: 4px; padding: 2px 6px; width: 100%; outline: none;
}
.wallet-menu-item .wm-rename:focus { border-color: #007aff; }
.pill-info { display: flex; flex-direction: column; line-height: 1.2; }
.pill-name { font-family: -apple-system, system-ui; font-size: 13px; font-weight: 500; }
.pill-addr { font-family: monospace; font-size: 10px; color: #888; }
.wallet-menu-sep { height: 1px; background: #e5e5e5; margin: 4px 0; }
.wallet-menu-item.new-wallet { font-family: -apple-system, system-ui; color: #007aff; }

.balances { display: flex; gap: 20px; margin: 10px 0; }
.bal { font-size: 14px; font-family: monospace; font-weight: 600; }
.bal span { font-weight: 400; color: #666; font-family: -apple-system, system-ui; font-size: 12px; }

.actions { display: flex; gap: 8px; margin: 10px 0; flex-wrap: wrap; }
.btn {
    font-size: 12px; padding: 6px 14px; border-radius: 8px; border: 1px solid #ddd;
    background: white; cursor: pointer; font-family: -apple-system, system-ui;
    display: flex; align-items: center; gap: 4px;
}
.btn:hover { background: #f0f0f0; }
.btn.primary { background: #111; color: white; border-color: #111; }
.btn.primary:hover { background: #333; }

.top-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

.divider { height: 1px; background: #e5e5e5; margin: 16px 0; }

/* Activity section */
.card { background: white; border-radius: 10px; padding: 12px; border: 1px solid #e5e5e5; }
.row { display: flex; align-items: center; padding: 6px 0; }
.row + .row { border-top: 1px solid #f0f0f0; }
.icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 14px; flex-shrink: 0; }
.icon.in { background: #dcfce7; color: #16a34a; }
.icon.out { background: #fff7ed; color: #ea580c; }
.details { flex: 1; min-width: 0; }
.label { font-size: 13px; font-weight: 500; }
.addr { font-size: 10px; color: #999; font-family: monospace; }
.amount { text-align: right; flex-shrink: 0; }
.amount .val { font-size: 13px; font-weight: 600; font-family: monospace; }
.amount .time { font-size: 10px; color: #999; }
.empty { text-align: center; padding: 32px 0; color: #999; font-size: 13px; }
#loading { text-align: center; padding: 32px 0; color: #999; font-size: 13px; }
</style>
</head>
<body>

<div id="wallet">
    <div class="top-row">
        <div style="position: relative;">
            <div class="wallet-addr" onclick="toggleWalletMenu(event)">
                <span id="wallet-address">No Wallet</span> â–¾
            </div>
            <div class="wallet-menu" id="wallet-menu"></div>
        </div>
    </div>

    <div class="balances">
        <div class="bal"><span id="eth-bal">...</span> <span>ETH</span></div>
        <div class="bal"><span id="usdc-bal">...</span> <span>USDC</span></div>
    </div>

    <div class="actions">
        <button class="btn primary" onclick="post('receive')">â†“ Receive</button>
        <button class="btn primary" onclick="post('send')">â†‘ Send</button>
        <button class="btn" onclick="post('pasteWC')">ðŸ”— WC</button>
        <button class="btn" id="sessions-btn" style="display:none" onclick="post('showSessions')">
            ðŸ”— <span id="sessions-count">0</span>
        </button>
    </div>
</div>

<div class="divider"></div>

<h3>Activity</h3>
<div id="loading">Loading...</div>
<div id="history"></div>

<script>
function makeBlockie(address) {
    var seed = address.toLowerCase();
    function xorshift(s) {
        s[0] ^= s[0] << 13; s[0] ^= s[0] >> 17; s[0] ^= s[0] << 5;
        return (s[0] >>> 0) / 4294967296;
    }
    var s = [0];
    for (var i = 0; i < seed.length; i++) {
        s[0] = (s[0] + seed.charCodeAt(i) * (i + 1)) | 0;
    }
    function randColor() {
        var h = Math.floor(xorshift(s) * 360);
        var sl = 40 + Math.floor(xorshift(s) * 20);
        var l = 40 + Math.floor(xorshift(s) * 30);
        return 'hsl(' + h + ',' + sl + '%,' + l + '%)';
    }
    var color = randColor(), bg = randColor(), spot = randColor();
    var data = [];
    for (var i = 0; i < 64; i++) {
        var r = xorshift(s);
        data.push(r < 0.33 ? 0 : r < 0.66 ? 1 : 2);
    }
    var c = document.createElement('canvas');
    c.width = 8; c.height = 8;
    var ctx = c.getContext('2d');
    var colors = [bg, color, spot];
    for (var i = 0; i < 64; i++) {
        var x = i % 8, y = Math.floor(i / 8);
        var mx = x < 4 ? x : 7 - x;
        ctx.fillStyle = colors[data[y * 4 + mx]];
        ctx.fillRect(x, y, 1, 1);
    }
    return c.toDataURL();
}

function post(action, data) {
    var msg = { action: action };
    if (data !== undefined) msg.data = data;
    window.webkit.messageHandlers.wallet.postMessage(JSON.stringify(msg));
}

var _walletState = {};

window.updateWallet = function(jsonStr) {
    var s = JSON.parse(jsonStr);
    _walletState = s;

    var addrEl = document.getElementById('wallet-address');
    if (s.address) {
        addrEl.innerHTML = '<img class="blockie" src="' + makeBlockie(s.address) + '">' +
            '<span class="pill-info"><span class="pill-name">' + (s.name || s.displayAddress) + '</span>' +
            '<span class="pill-addr">' + (s.displayAddress || '') + '</span></span>';
    } else {
        addrEl.textContent = 'No Wallet';
    }
    document.getElementById('eth-bal').textContent = s.ethBalance || '...';
    document.getElementById('usdc-bal').textContent = s.usdcBalance || '...';

    var sessBtn = document.getElementById('sessions-btn');
    if (s.sessionsCount > 0) {
        sessBtn.style.display = '';
        document.getElementById('sessions-count').textContent = s.sessionsCount;
    } else {
        sessBtn.style.display = 'none';
    }

    buildWalletMenu(s.wallets || [], s.selectedIndex || 0);
};

function buildWalletMenu(wallets, selectedIndex) {
    var menu = document.getElementById('wallet-menu');
    menu.innerHTML = '';
    wallets.forEach(function(w) {
        var btn = document.createElement('button');
        btn.className = 'wallet-menu-item' + (w.index === selectedIndex ? ' active' : '');
        btn.onclick = function() { selectWallet(w.index); };
        btn.ondblclick = function(e) { e.stopPropagation(); startRename(btn, w); };
        var img = '';
        if (w.address) img = '<img class="blockie" src="' + makeBlockie(w.address) + '">';
        btn.innerHTML = img + '<span class="wm-info"><span class="wm-name">' + (w.name || w.display) +
            '</span><span class="wm-addr">' + w.display + '</span></span>';
        menu.appendChild(btn);
    });
    if (wallets.length > 0) {
        var sep = document.createElement('div');
        sep.className = 'wallet-menu-sep';
        menu.appendChild(sep);
    }
    var newBtn = document.createElement('button');
    newBtn.className = 'wallet-menu-item new-wallet';
    newBtn.textContent = 'New Wallet';
    newBtn.onclick = function() { post('newWallet'); };
    menu.appendChild(newBtn);
}

function startRename(btn, wallet) {
    var info = btn.querySelector('.wm-info');
    if (!info) return;
    var input = document.createElement('input');
    input.className = 'wm-rename';
    input.value = wallet.name || '';
    info.innerHTML = '';
    info.appendChild(input);
    input.focus();
    input.select();
    function commit() {
        var name = input.value.trim();
        if (name && name !== wallet.name) {
            post('renameWallet', { index: wallet.index, name: name });
        }
    }
    input.onkeydown = function(e) {
        if (e.key === 'Enter') { commit(); input.blur(); }
        if (e.key === 'Escape') { input.blur(); }
    };
    input.onblur = function() { commit(); };
}

function selectWallet(index) {
    closeMenus();
    post('selectWallet', index);
}

function toggleWalletMenu(e) {
    e.stopPropagation();
    document.getElementById('wallet-menu').classList.toggle('open');
}

function closeMenus() {
    document.getElementById('wallet-menu').classList.remove('open');
}

document.addEventListener('click', closeMenus);

window.updateHistory = function(txListJson) {
    var txs = JSON.parse(txListJson);
    var container = document.getElementById('history');
    document.getElementById('loading').style.display = 'none';

    if (!txs.length) {
        container.innerHTML = '<div class="empty">No transactions yet.</div>';
        return;
    }

    var html = '<div class="card">';
    txs.forEach(function(tx) {
        var icon = tx.incoming ? 'in' : 'out';
        var label = tx.incoming ? 'Received' : 'Sent';
        var sign = tx.incoming ? '+' : '-';
        html += '<div class="row">' +
            '<div class="icon ' + icon + '">' + (tx.incoming ? 'â†“' : 'â†‘') + '</div>' +
            '<div class="details">' +
                '<div class="label">' + label + '</div>' +
                '<div class="addr">' + tx.address + '</div>' +
            '</div>' +
            '<div class="amount">' +
                '<div class="val">' + sign + tx.value + ' ' + tx.symbol + '</div>' +
                '<div class="time">' + tx.time + '</div>' +
            '</div>' +
        '</div>';
    });
    html += '</div>';
    container.innerHTML = html;
};
</script>
</body>
</html>
