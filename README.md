# üõ°Ô∏è Enclave

**The Secure Web3 Operating System for macOS.**

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Platform: macOS](https://img.shields.io/badge/Platform-macOS%2014+-black.svg?logo=apple)]()
[![Swift](https://img.shields.io/badge/Swift-5.9+-orange.svg?logo=swift)]()
[![Network: Arbitrum](https://img.shields.io/badge/Network-Arbitrum%20L2-28A0F0.svg?logo=arbitrum)]()
[![Standard: ERC-4337](https://img.shields.io/badge/Standard-ERC--4337-lightgrey.svg)]()

**Enclave** is a native macOS application that fundamentally redesigns how users interact with Web3. Rather than forcing standard Ethereum cryptography (`secp256k1`) into vulnerable Web2 browser extensions, Enclave leverages **Apple's physical Secure Enclave (`secp256r1`)** and **Account Abstraction (ERC-4337)** to turn your Mac into a literal hardware wallet.

Private keys are generated in silicon, physically cannot be extracted by malware, and are mathematically verified on-chain via modern Layer-2 precompiles (RIP-7212).

---

## üìñ The Philosophy

The current standard of injecting a global `window.ethereum` JavaScript object into a standard web browser is fundamentally broken. Users lose billions to front-end compromises, DNS hijacking, poisoned libraries, and malicious browser extensions.

Enclave is built strictly on two uncompromising principles:

### 1. Best-In-Class Security

* **True Hardware Isolation:** Keys never leave the hardware. Your private key is physically bound to your Mac's motherboard and biometric sensor. Transactions are signed strictly via **Touch ID**.
* **The Walled Garden:** Enclave abandons the browser extension model entirely. dApps run inside isolated, sandboxed native views (`WKWebView`) within the wallet application.
* **No JS Injection:** `window.ethereum` does not exist here. All communication happens via a strictly typed, native Swift bridge (`WKScriptMessageHandler`).
* **Immutable dApps:** dApps are explicitly versioned, loaded strictly via IPFS, and must be cryptographically signed by verified developers.

### 2. Delightful User Experience

* **Native Speed:** Optimistic UI updates make Web3 feel like a centralized service. When Touch ID succeeds, balances update instantly while the Bundler handles blockchain settlement seamlessly in the background.
* **Gas Abstraction:** Users never need to hold native ETH to pay for network fees. Enclave uses ERC-4337 Paymasters to sponsor gas entirely or allow payments in USDC.
* **Atomic Batching:** Approve a token and execute a swap in a single Touch ID confirmation.
* **Human-Readable Previews:** Unified transaction previews ensure you know exactly what is happening *before* the biometric prompt appears (e.g., *"üü¢ Receive 3,000 USDC, üî¥ Pay 1 ETH"*). No more blind signing hex strings.

---

## üèóÔ∏è Core Architecture & V1 Scope

Enclave bridges Apple's proprietary silicon to the Ethereum Virtual Machine (EVM) by orchestrating three isolated layers. **V1 is explicitly targeted at Arbitrum L2**, which natively supports the **RIP-7212 precompile** at address `0x0100` for cheap P-256 signature verification.

### V1 Features (Current Branch)

- [x] **Secure Enclave Engine:** Hardware key generation via `CryptoKit` bound to `.biometryCurrentSet`.
- [x] **Ghost Deployment (CREATE2):** Deterministic calculation of the Arbitrum smart wallet address using the Mac's hardware X/Y coordinates before it exists on-chain.
- [x] **The EVM "High-S" Math Fix:** Native Swift logic using `BigInt` to mathematically flip high `S` values generated by the Secure Enclave, ensuring strict EVM anti-malleability compliance.
- [x] **The Walled Garden:** A bundled, self-contained HTML/JS "Kitchen Sink" dApp loaded in a heavily restricted `WKWebView`.
- [ ] **Bundler Integration:** Constructing the ERC-4337 `UserOperation` (including the `initCode` to deploy the wallet just-in-time) and submitting it to an Arbitrum Bundler (e.g., Alchemy/Pimlico).

---

## üõ†Ô∏è Getting Started (Local Development)

We welcome Swift engineers, Solidity developers, and cryptographers. Here is how to run the V1 prototype locally.

### Prerequisites

* **macOS 14.0+** (Requires a physical Mac with Touch ID; Enclave cannot be fully simulated in a VM).
* **Xcode 15.0+**
* Foundry (for local smart contract testing)

### Build Instructions

1. Clone the repository:
   ```bash
   git clone https://github.com/Plether-fi/enclave.git
   cd enclave
   ```
2. Open `Enclave.xcodeproj` in Xcode.
3. **CRITICAL:** Go to **Project Settings ‚Üí Target ‚Üí Signing & Capabilities**. You must select your Apple Developer Team and add the **Keychain Sharing** capability. If you do not do this, CryptoKit will instantly crash due to access control restrictions when attempting to reach the Secure Enclave.
4. Ensure the Swift Package Manager has resolved the `attaswift/BigInt` dependency.
5. Build and Run (`Cmd + R`).

### Testing the Walled Garden

When the app launches, you will see the "Kitchen Sink" dApp. Click "Send 1 USDC".

1. The `WKWebView` will pause via the native bridge.
2. The native macOS Touch ID prompt will appear.
3. Upon physical authentication, the Xcode console will print the strictly formatted, EVM-compliant 64-byte `0x...` signature ready for the Arbitrum Bundler.

---

## ‚ö†Ô∏è Cryptographic Traps (Must Read for Contributors)

If you are contributing to the cryptographic engine or the Smart Contract, please be aware of the following:

### 1. The "High-S" Malleability Rule (EIP-2)

Apple's Secure Enclave does not care about Ethereum's strict malleability rules. It randomly generates signatures with an `s` value in the upper half of the curve (~50% of the time). The EVM strictly rejects high `s` values to prevent transaction replay attacks.

**The Rule:** In `EnclaveEngine.swift`, we capture the raw signature, check if `s > N/2` using the `BigInt` library, and mathematically flip it (`s = N - s`). Do not alter this logic, or ~50% of Arbitrum transactions will mysteriously fail.

### 2. Counterfactual Deployment

The Mac app does not send a standard transaction to "create" the wallet. It mathematically calculates what the address *will be* using the `CREATE2` opcode. The wallet is natively deployed by the Arbitrum Bundler during the user's very first outbound transaction via the `initCode` field.

---

## ü§ù How to Contribute

Enclave is an open-source project. We are actively looking for help in the following areas:

* **Transaction Simulation Engine:** Hooking up an API (like Alchemy Simulate or Tenderly) to decode the raw transaction hex and display a human-readable prompt inside the native SwiftUI view before the Touch ID prompt appears.
* **Bundler Networking:** Writing the Swift networking layer to cleanly construct the `UserOperation` JSON and POST it to standard Arbitrum bundlers.
* **EIP-1271 Implementation:** Upgrading the Solidity Smart Contract to support `isValidSignature` so the wallet can seamlessly sign off-chain messages (e.g., logging into OpenSea or Snapshot).
* **IPFS dApp Resolver:** Building the native Swift architecture to securely fetch, verify developer signatures, and load versioned HTML/JS payloads from IPFS directly into the Walled Garden.

---

## üìÑ License

This project is released under the [MIT License](https://opensource.org/licenses/MIT).
